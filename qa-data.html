<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>RAP Companion</title>
  <meta name="description" content="A technical communication document intended to give assistance to people developing a Reproducible Analytical Pipeline using DataOps.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="RAP Companion" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="images/cover.png" />
  <meta property="og:description" content="A technical communication document intended to give assistance to people developing a Reproducible Analytical Pipeline using DataOps." />
  <meta name="github-repo" content="mammykins/rap-companion" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="RAP Companion" />
  <meta name="twitter:site" content="@mammykins_" />
  <meta name="twitter:description" content="A technical communication document intended to give assistance to people developing a Reproducible Analytical Pipeline using DataOps." />
  <meta name="twitter:image" content="images/cover.png" />

<meta name="author" content="Matthew Gregory, Matthew Upson">


<meta name="date" content="2017-10-10">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="dep.html">
<link rel="next" href="pub.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-102661099-1', 'auto');
  ga('send', 'pageview');

</script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">RAP Companion</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#discovery"><i class="fa fa-check"></i><b>0.1</b> Discovery</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#getting-the-balance-right"><i class="fa fa-check"></i><b>0.2</b> Getting the balance right</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#inspiration"><i class="fa fa-check"></i><b>0.3</b> Inspiration</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#objectives"><i class="fa fa-check"></i><b>1.1</b> Objectives</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ethics.html"><a href="ethics.html"><i class="fa fa-check"></i><b>2</b> Ethical Considerations</a><ul>
<li class="chapter" data-level="2.1" data-path="ethics.html"><a href="ethics.html#extra-detail"><i class="fa fa-check"></i><b>2.1</b> Extra detail</a><ul>
<li class="chapter" data-level="2.1.1" data-path="ethics.html"><a href="ethics.html#start-with-clear-user-need-and-public-benefit"><i class="fa fa-check"></i><b>2.1.1</b> Start with clear user need and public benefit</a></li>
<li class="chapter" data-level="2.1.2" data-path="ethics.html"><a href="ethics.html#use-data-and-tools-which-have-the-minimum-intrusion-necessary"><i class="fa fa-check"></i><b>2.1.2</b> Use data and tools which have the minimum intrusion necessary</a></li>
<li class="chapter" data-level="2.1.3" data-path="ethics.html"><a href="ethics.html#create-robust-data-science-models"><i class="fa fa-check"></i><b>2.1.3</b> Create robust data science models</a></li>
<li class="chapter" data-level="2.1.4" data-path="ethics.html"><a href="ethics.html#be-alert-to-public-perceptions"><i class="fa fa-check"></i><b>2.1.4</b> Be alert to public perceptions</a></li>
<li class="chapter" data-level="2.1.5" data-path="ethics.html"><a href="ethics.html#be-as-open-and-accountable-as-possible"><i class="fa fa-check"></i><b>2.1.5</b> Be as open and accountable as possible</a></li>
<li class="chapter" data-level="2.1.6" data-path="ethics.html"><a href="ethics.html#keep-data-secure"><i class="fa fa-check"></i><b>2.1.6</b> Keep data secure</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>3</b> Why RAP?</a><ul>
<li class="chapter" data-level="3.1" data-path="why.html"><a href="why.html#the-current-statistics-production-process"><i class="fa fa-check"></i><b>3.1</b> The current statistics production process</a><ul>
<li class="chapter" data-level="3.1.1" data-path="why.html"><a href="why.html#the-problem-with-this-approach"><i class="fa fa-check"></i><b>3.1.1</b> The problem with this approach</a></li>
<li class="chapter" data-level="3.1.2" data-path="why.html"><a href="why.html#desired-reproducible-analytical-pipeline"><i class="fa fa-check"></i><b>3.1.2</b> Desired Reproducible Analytical Pipeline</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="why.html"><a href="why.html#why-learning-to-rap-might-be-hard"><i class="fa fa-check"></i><b>3.2</b> Why learning to RAP might be hard</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="exemplar.html"><a href="exemplar.html"><i class="fa fa-check"></i><b>4</b> Exemplar RAP</a><ul>
<li class="chapter" data-level="4.1" data-path="exemplar.html"><a href="exemplar.html#package-purpose"><i class="fa fa-check"></i><b>4.1</b> Package Purpose</a></li>
<li class="chapter" data-level="4.2" data-path="exemplar.html"><a href="exemplar.html#tidy-data"><i class="fa fa-check"></i><b>4.2</b> Tidy data</a><ul>
<li class="chapter" data-level="4.2.1" data-path="exemplar.html"><a href="exemplar.html#eesectors-tidy-data"><i class="fa fa-check"></i><b>4.2.1</b> eesectors tidy data</a></li>
<li class="chapter" data-level="4.2.2" data-path="exemplar.html"><a href="exemplar.html#what-does-our-eesectors-tidy-data-look-like"><i class="fa fa-check"></i><b>4.2.2</b> What does our eesectors tidy data look like?</a></li>
<li class="chapter" data-level="4.2.3" data-path="exemplar.html"><a href="exemplar.html#how-to-build-your-tidy-data"><i class="fa fa-check"></i><b>4.2.3</b> How to build your tidy data?</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="exemplar.html"><a href="exemplar.html#eesectors-package-exploration"><i class="fa fa-check"></i><b>4.3</b> <code>eesectors</code> Package Exploration</a><ul>
<li class="chapter" data-level="4.3.1" data-path="exemplar.html"><a href="exemplar.html#installation"><i class="fa fa-check"></i><b>4.3.1</b> Installation</a></li>
<li class="chapter" data-level="4.3.2" data-path="exemplar.html"><a href="exemplar.html#loading-the-package"><i class="fa fa-check"></i><b>4.3.2</b> Loading the package</a></li>
<li class="chapter" data-level="4.3.3" data-path="exemplar.html"><a href="exemplar.html#explore-the-package"><i class="fa fa-check"></i><b>4.3.3</b> Explore the package</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="exemplar.html"><a href="exemplar.html#chapter-plenary"><i class="fa fa-check"></i><b>4.4</b> Chapter plenary</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="open.html"><a href="open.html"><i class="fa fa-check"></i><b>5</b> Open Source rather than proprietary</a></li>
<li class="chapter" data-level="6" data-path="vs.html"><a href="vs.html"><i class="fa fa-check"></i><b>6</b> Version Control</a><ul>
<li class="chapter" data-level="6.1" data-path="vs.html"><a href="vs.html#introduction"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="vs.html"><a href="vs.html#useful-resources"><i class="fa fa-check"></i><b>6.2</b> Useful resources</a><ul>
<li class="chapter" data-level="6.2.1" data-path="vs.html"><a href="vs.html#graphical-user-interface-focus"><i class="fa fa-check"></i><b>6.2.1</b> Graphical user interface focus</a></li>
<li class="chapter" data-level="6.2.2" data-path="vs.html"><a href="vs.html#git-and-rstudio"><i class="fa fa-check"></i><b>6.2.2</b> Git and RStudio</a></li>
<li class="chapter" data-level="6.2.3" data-path="vs.html"><a href="vs.html#command-line-focus"><i class="fa fa-check"></i><b>6.2.3</b> Command line focus</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="vs.html"><a href="vs.html#typical-workflow"><i class="fa fa-check"></i><b>6.3</b> Typical workflow</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="package.html"><a href="package.html"><i class="fa fa-check"></i><b>7</b> Packaging Code</a><ul>
<li class="chapter" data-level="7.1" data-path="package.html"><a href="package.html#essential-reading"><i class="fa fa-check"></i><b>7.1</b> Essential reading</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="test.html"><a href="test.html"><i class="fa fa-check"></i><b>8</b> Unit test</a><ul>
<li class="chapter" data-level="8.1" data-path="test.html"><a href="test.html#further-reading"><i class="fa fa-check"></i><b>8.1</b> Further Reading</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="travis.html"><a href="travis.html"><i class="fa fa-check"></i><b>9</b> Automated Testing</a></li>
<li class="chapter" data-level="10" data-path="code-cover.html"><a href="code-cover.html"><i class="fa fa-check"></i><b>10</b> Code coverage</a></li>
<li class="chapter" data-level="11" data-path="dep.html"><a href="dep.html"><i class="fa fa-check"></i><b>11</b> Dependency management</a></li>
<li class="chapter" data-level="12" data-path="qa-data.html"><a href="qa-data.html"><i class="fa fa-check"></i><b>12</b> Quality Assurance of the pipeline</a><ul>
<li class="chapter" data-level="12.1" data-path="qa-data.html"><a href="qa-data.html#testing-the-input-data"><i class="fa fa-check"></i><b>12.1</b> Testing the input data</a></li>
<li class="chapter" data-level="12.2" data-path="qa-data.html"><a href="qa-data.html#murphys-law-and-errors-in-your-pipeline"><i class="fa fa-check"></i><b>12.2</b> Murphy’s Law and errors in your pipeline</a></li>
<li class="chapter" data-level="12.3" data-path="qa-data.html"><a href="qa-data.html#error-handling-1"><i class="fa fa-check"></i><b>12.3</b> Error handling</a></li>
<li class="chapter" data-level="12.4" data-path="qa-data.html"><a href="qa-data.html#error-logging"><i class="fa fa-check"></i><b>12.4</b> Error logging</a><ul>
<li class="chapter" data-level="12.4.1" data-path="qa-data.html"><a href="qa-data.html#pipeline-pitfalls"><i class="fa fa-check"></i><b>12.4.1</b> Pipeline pitfalls</a></li>
<li class="chapter" data-level="12.4.2" data-path="qa-data.html"><a href="qa-data.html#error-logging-using-futile.logger"><i class="fa fa-check"></i><b>12.4.2</b> Error logging using <code>futile.logger</code></a></li>
<li class="chapter" data-level="12.4.3" data-path="qa-data.html"><a href="qa-data.html#logging-to-file"><i class="fa fa-check"></i><b>12.4.3</b> Logging to file</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="pub.html"><a href="pub.html"><i class="fa fa-check"></i><b>13</b> Producing the publication</a><ul>
<li class="chapter" data-level="13.1" data-path="pub.html"><a href="pub.html#further-reading-1"><i class="fa fa-check"></i><b>13.1</b> Further Reading</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="final.html"><a href="final.html"><i class="fa fa-check"></i><b>14</b> Final Thoughts</a><ul>
<li class="chapter" data-level="14.1" data-path="final.html"><a href="final.html#user-feedback"><i class="fa fa-check"></i><b>14.1</b> User feedback</a></li>
<li class="chapter" data-level="14.2" data-path="final.html"><a href="final.html#just-the-beginning"><i class="fa fa-check"></i><b>14.2</b> Just the beginning…</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">RAP Companion</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="qa_data" class="section level1">
<h1><span class="header-section-number">Chapter 12</span> Quality Assurance of the pipeline</h1>
<p>All the testing we have described so far is to do with the code, and ensuring that the code does what we expect it to, but because we have written an <a href="https://github.com/ukgovdatascience/eesectors">R package</a>, it’s also very easy for us to institute tests for the consistency of the data at the time the data is loaded. We may also wish to employ defensive programming against potential errors and consider how we might want to flag these for the user and / or how our pipeline might recover from such errors.</p>
<div id="testing-the-input-data" class="section level2">
<h2><span class="header-section-number">12.1</span> Testing the input data</h2>
<p>If our RAP were a sausage factory, the data would be the input meat. Given we do not own the input data nor are we responsible for its preparation we should plan for how we can protect our pipeline against a change in input data format or any anomalous data therein.</p>
<p>The list of tests that we might want to run is endless, and the scope of tests very much be dictated by the team which has the expert knowledge of the data. In the <a href="https://github.com/ukgovdatascience/eesectors">eesectors</a> package we implemented two very simple checks, but these could very easily be expanded. The simplest of these is a simple test for outliers: since the data for the economic estimates is longitudinal, i.e. stretching back several years; we are able to look at the most recent values in comparison to the values from previous years. If the latest values lie within a threshold determined statistically from the other values then the data passes, if not a warning is raised.</p>
<p>These kinds of automated tests are repeated every time the data are loaded, reducing the burden of QA, and the scope for human error, freeing up statistician time for identifying more subtle data quality issues which might otherwise go unnoticed.</p>
</div>
<div id="murphys-law-and-errors-in-your-pipeline" class="section level2">
<h2><span class="header-section-number">12.2</span> Murphy’s Law and errors in your pipeline</h2>
<p>Paraphrasing from <a href="http://adv-r.had.co.nz/beyond-exception-handling.html">Advanced R</a> by Hadley Wickham:</p>
<p>If something can go wrong, it will: the format of the spreadsheet you normally receive your raw data in changes, the server you’re talking to may be down, your Wi-Fi drops. Any such problem may stop a piece of your pipeline (code) from doing what it is intended to do. This is not a bug; the problem did not originate from within the code itself. However, if the pipeline downstream is dependent on this code acting as intended then you have a problem, you need to deal with the error somehow. Errors aren’t caused by bugs <em>per se</em>, but neglecting to handle an error appropriately is a bug.</p>
</div>
<div id="error-handling-1" class="section level2">
<h2><span class="header-section-number">12.3</span> Error handling</h2>
<p>Not all problems are unexpected. For example, an input data file may be missing. We can often anticipate some of these likely problems by thinking about our users and how the code we might be implemented or misunderstood. If something goes wrong, we want the user to know about it. We can communicate to the user using a variety of conditions; messages, warnings and errors.</p>
<p>If we want to let the user know about something fairly inoccuous or keep them informed we can use the <code>message()</code> function. Sometimes we might want to draw the users attention to something that might be problematic without stopping the code from running, using <code>warning()</code>. If there’s no way for the code to execute then a fatal error may be preferred using <code>stop()</code>.</p>
<p>As an example we look to code from the RAP <code>eesectors</code> <a href="https://github.com/DCMSstats/eesectors/">package</a> produced in collaboration with DCMS. Specifically, we look at a snippet of code from the <code>year_sector_data</code> <a href="https://github.com/DCMSstats/eesectors/blob/master/R/year_sector_data.R">function</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">message</span>(<span class="st">&#39;Checking x does not contain missing values...&#39;</span>)
  if (<span class="kw">anyNA</span>(x)) <span class="kw">stop</span>(<span class="st">&quot;x cannot contain any missing values&quot;</span>)

  <span class="kw">message</span>(<span class="st">&#39;Checking for the correct number of rows...&#39;</span>)
  if (<span class="kw">nrow</span>(x) !=<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(x$sector)) *<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(x$year))) {

    <span class="kw">warning</span>(<span class="st">&quot;x does not appear to be well formed. nrow(x) should equal</span>
<span class="st">length(unique(x$sector)) * length(unique(x$year)). Check the of x.&quot;</span>)
  }
  
  <span class="kw">message</span>(<span class="st">&#39;...passed&#39;</span>)</code></pre></div>
<p>We’ll work our way through the code above, step by step. The first line informs the user of the quality assurance that is being automatically conducted, i.e. that no data is missing (<code>NA</code>). The second line uses the logical <code>if</code> statement to assess this on <code>x</code> and if it were true, we use <code>stop</code> to produce a fatal error with a descriptive message, as below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;culture&quot;</span>, <span class="st">&quot;sport&quot;</span>, <span class="ot">NA</span>)

  <span class="kw">message</span>(<span class="st">&#39;Checking x does not contain missing values...&#39;</span>)</code></pre></div>
<pre><code>## Checking x does not contain missing values...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  if (<span class="kw">anyNA</span>(x)) <span class="kw">stop</span>(<span class="st">&quot;x cannot contain any missing values&quot;</span>)</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): x cannot contain any missing values</code></pre>
<p>The third line checks that the data has data for each sector for each year (indirectly). If not it throws up a warning, as this could be for a valid reason (e.g. a change of name of a factor level), but it’s better to let the user know rather than let it quietly pass. Thus all the expert domain knowledge can be incorporated into the code through condition handling, providing transparent quality assurance.</p>
<p>These informative messages are useful but when used in conjuction with <code>tryCatch</code>, we can implement our own custom responses to a message, warning or error (this is explained in the <a href="http://adv-r.had.co.nz/Exceptions-Debugging.html">relevant Advanced R Chapter</a>). We demonstrate a simplified example from the <code>eesectors</code> package where an informative message is provided. This is achieved by wrapping the main body of the function within the <code>tryCatch</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Define as a method</span>
figure3<span class="fl">.1</span> &lt;-<span class="st"> </span>function(x, ...) {
  
  out &lt;-<span class="st"> </span><span class="kw">tryCatch</span>(
    <span class="dt">expr =</span> {      
      
      p &lt;-<span class="st"> </span><span class="kw">plot</span>(x, y)
      
      <span class="kw">return</span>(p)

      },
    <span class="dt">warning =</span> function() {

      w &lt;-<span class="st"> </span><span class="kw">warnings</span>()
      <span class="kw">warning</span>(<span class="st">&#39;Warning produced running figure3.1():&#39;</span>, w)

    },
    <span class="dt">error =</span> function(e)  {

      <span class="kw">stop</span>(<span class="st">&#39;Error produced running figure3.1():&#39;</span>, e)

    },
    <span class="dt">finally =</span> {}
  )
}</code></pre></div>
<p>The body of a <code>tryCatch()</code> must be a single expression; using <code>{</code> we combine several expressions into a single form. This a simple addition to our function but it’s powerful in that it provides the user with more information for anticipated problems.</p>
<p>By wrapping the code in the <code>tryCatch</code> function we ensure that it gets evaluated, whereas normally an error would cause the evaluation of the code to <code>stop</code>. Instead we get the error and the evaluation of the next line of code.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">try</span>(<span class="kw">print</span>(this_object_does_not_exist)); <span class="kw">print</span>(<span class="st">&quot;What happens if this is not wrapped in try?&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;What happens if this is not wrapped in try?&quot;</code></pre>
</div>
<div id="error-logging" class="section level2">
<h2><span class="header-section-number">12.4</span> Error logging</h2>
<p>We are increasingly using R and software packages like our RAP in “operational” settings that require robust error handling and logging. In this section we describe a quick-and-dirty way to get python style multi-level log files by wrapping the <code>futile.logger</code> package inspired by this <a href="https://www.r-bloggers.com/python-style-logging-in-r/">blog post</a>.</p>
<div id="pipeline-pitfalls" class="section level3">
<h3><span class="header-section-number">12.4.1</span> Pipeline pitfalls</h3>
<p>Our real world scenario involves an R package that processes raw data (typically from a spreadsheet or SQL table) that is updated periodically. The raw data can come from various different sources, set up by different agencies and usually manually procured or copy and pasted together prioritising human readability over machine readability.</p>
<p>Data could be missing or in a different layout from that which we are use to, for a variety of reasons, before it even gets to us. And then our R functions within our package may extract this data and perform various checks on it. From there a user (analyst / statistician) may put together a statistical report using Rmarkdown ultimately resulting in a html document. This pipeline has lots of steps and potential to encounter problems throughout.</p>
<p>As we develop our RAP for our intended bespoke problem and start to use it in an operational setting, we must ensure that in this chaotic environment we protect ourselves against things going wrong without our realising. One of the methods for working with chaotic situations in operational software is to have lots and Lots and LOTS of logging.</p>
<p>We take our inspirration from Python, which has the brilliant “logging” module that allows us to quickly set up separate output files for log statements at different levels. This is important as we have different users who may have different needs from the log files. For example, the data scientist / analyst who did the programming for the RAP package may wish to debug the code on logging an error whereas a statistician may prefer to be notified only when an ERROR or something FATAL occurred.</p>
</div>
<div id="error-logging-using-futile.logger" class="section level3">
<h3><span class="header-section-number">12.4.2</span> Error logging using <code>futile.logger</code></h3>
<p>Fortunately there’s a package available on CRAN that makes this process easy in R called <code>futile.logger</code>. There are a few concepts that it’s helpful to be familiar with before proceeding which are introduced in this <a href="https://www.r-bloggers.com/better-logging-in-r-aka-futile-logger-1-3-0-released/">blog post</a> by the package author.</p>
<p>One approach is to replace <code>tryCatch</code> with the <code>ftry</code> function with the <code>finally</code>. This function integrates <code>futile.logger</code> with the error and warning system so problems can be caught both in the standard R warning system, while also being emitted via <code>futile.logger</code>.</p>
<p>We think about how to adapt our earlier code to this function. The primary use case for <code>futile.logger</code> is to write out log messages. There are log writers associated with all the predefined log levels: TRACE, DEBUG, INFO, WARN, ERROR, FATAL. Log messages will only be written if the log level is equal to or more urgent than the current threshold. By default the ROOT logger is set to INFO but this can be adjusted by the user facilitating customisation of the error logging to meet the needs of the current user (by using the <code>flog.threshold</code> function).</p>
<p>We demonstrate this hierarchy below by evaluating this code.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># library(futile.logger)</span>

futile.logger::<span class="kw">flog.debug</span>(<span class="st">&quot;This won&#39;t print&quot;</span>) 
futile.logger::<span class="kw">flog.info</span>(<span class="st">&quot;But this %s&quot;</span>, <span class="st">&#39;will&#39;</span>) 
futile.logger::<span class="kw">flog.warn</span>(<span class="st">&quot;As will %s&quot;</span>, <span class="st">&#39;this&#39;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;culture&quot;</span>, <span class="st">&quot;sport&quot;</span>, <span class="ot">NA</span>)

  <span class="kw">message</span>(<span class="st">&#39;Checking x does not contain missing values...&#39;</span>)
  if (<span class="kw">anyNA</span>(x)) <span class="kw">stop</span>(<span class="st">&quot;x cannot contain any missing values&quot;</span>)</code></pre></div>
<p>We start by re-writing the above code using the <code>futile.logger</code> high level interface. As the default setting is at the INFO log level we can use <code>flog.trace</code> to hide most of the checks and messages from a typical user.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Data from raw has an error</span>
x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;culture&quot;</span>, <span class="st">&quot;sport&quot;</span>, <span class="ot">NA</span>)

### Non-urgent log level
futile.logger::<span class="kw">flog.trace</span>(<span class="st">&quot;Checking x does not contain missing values...&quot;</span>)
### Urgent log level, use capture to print out data structure
  if (<span class="kw">anyNA</span>(x))
  {
    futile.logger::<span class="kw">flog.error</span>(<span class="st">&quot;x cannot contain any missing values.&quot;</span>, 
               x, <span class="dt">capture =</span> <span class="ot">TRUE</span>)
  }

futile.logger::<span class="kw">flog.info</span>(<span class="st">&quot;Finished checks.&quot;</span>)</code></pre></div>
<p>The above example can help the user identify where the pipeline is going wrong by logging the error and capturing the object <code>x</code> where the data is missing. This allows us to more quickly track down what’s going wrong.</p>
</div>
<div id="logging-to-file" class="section level3">
<h3><span class="header-section-number">12.4.3</span> Logging to file</h3>
<p>At the moment we default to writing our log to the console. We could write to a file if interested using the <code>appender</code> family of functions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Print log messages to the console</span>
futile.logger::<span class="kw">appender.console</span>()

<span class="co"># Write log messages to a file</span>
futile.logger::<span class="kw">appender.file</span>(<span class="st">&quot;rap_companion.log&quot;</span>)

<span class="co"># Write log messages to console and a file</span>
futile.logger::<span class="kw">appender.tee</span>(<span class="st">&quot;rap_companion.log&quot;</span>)</code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="dep.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="pub.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
